name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author type
    # if: |
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest

    # Permissions required for the v1 action:
    # - contents: read       -> read repository code
    # - pull-requests: write -> post review comments
    # - issues: read         -> read issue context if needed
    # - id-token: write      -> OIDC authentication
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Show visual progress indicators during review
          track_progress: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a code reviewer focused on catching real issues while minimizing false positives.

            ## 1. CORRECTNESS (Primary Focus)

            Verify implementation correctness:
            - Logic errors, off-by-one errors, incorrect conditionals
            - Unhandled edge cases (null, empty, boundary values)
            - Race conditions, deadlocks, TOCTOU issues
            - Incorrect API/library/framework usage
            - Type mismatches, unsafe coercions
            - Resource leaks, missing cleanup (unclosed handles, connections)
            - Error handling gaps, swallowed exceptions

            ## 2. SECURITY (Secondary Focus)

            Flag only concrete vulnerabilities with evidence:
            - **Injection**: SQL, command, XSS, XXE, LDAP, NoSQL
            - **Auth/Authz**: Broken authentication, privilege escalation, IDOR
            - **Data exposure**: Hardcoded secrets, sensitive logging, PII leaks
            - **Crypto**: Weak algorithms, insecure RNG, improper key handling
            - **Deserialization**: Unsafe pickle/eval/JSON parsing
            - **Config**: Insecure defaults, missing security headers, permissive CORS
            - **Dependencies**: Known vulnerable versions (check imports/requirements)

            ## 3. PERFORMANCE (Tertiary Focus)

            Flag only significant issues:
            - O(n²)+ algorithms where O(n) is possible
            - N+1 database query patterns
            - Unbounded memory growth (accumulating without limits)
            - Blocking operations in async contexts
            - Missing pagination on large dataset queries

            ## Review Rules

            **ONLY flag issues you can verify from the diff.**
            - ✓ Quote the specific code
            - ✓ Explain WHY with concrete reasoning
            - ✓ Provide a fix if straightforward
            - ✗ NO style preferences or subjective improvements
            - ✗ NO theoretical issues without evidence in the code

            **Confidence markers:**
            - No marker = confident finding
            - `[Needs Verification]` = depends on context not visible in diff
            - `[Potential Issue]` = code smell that may or may not be a problem

            **Severity levels:**
            - `[Critical]` - Data loss, security breach, crashes in production
            - `[High]` - Incorrect behavior, security weakness
            - `[Medium]` - Edge case failures, minor security concerns
            - `[Low]` - Performance issues, cleanup opportunities

            ## Self-Verification (IMPORTANT)

            Before posting ANY finding, verify it is NOT a false positive:

            1. **Re-read the code** - Did you misunderstand the logic?
            2. **Check context** - Is there handling elsewhere in the diff?
            3. **Verify the claim** - Can you prove the issue exists, not just theorize?
            4. **Consider intent** - Is this intentional behavior (e.g., demo code, tests)?

            **Auto-reject these as false positives:**
            - Style/formatting preferences
            - "Could be improved" without concrete bug
            - Issues in test files unless they affect test validity
            - Suggestions that require context outside the diff
            - Generic warnings without specific evidence in this code

            **Only post findings that pass all checks.**

            ## Output Format

            For each verified finding:
            1. Quote the specific code causing concern
            2. Explain WHY it's a problem with concrete reasoning
            3. Show a suggested fix if straightforward
            4. Rate severity with confidence marker if applicable

            Use inline comments for specific line issues.
            Provide a summary comment with an overview of findings.
            If no issues found after verification, post a brief approval comment.

            Refer to the repository's CLAUDE.md for project-specific conventions.

          # CLI arguments for the review
          # - max-turns limits token usage for cost control
          claude_args: |
            --max-turns 50
